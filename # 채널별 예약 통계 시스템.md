# ì±„ë„ë³„ ì˜ˆì•½ í†µê³„ ì‹œìŠ¤í…œ

## ğŸ“‹ í”„ë¡œì íŠ¸ ê°œìš”

allmytour.comì˜ ë‹¤ì–‘í•œ ì˜ˆì•½ ì±„ë„ë³„ í†µê³„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°íšŒí•˜ê³  ì—‘ì…€ë¡œ ì¶”ì¶œí•  ìˆ˜ ìˆëŠ” ë°±ì˜¤í”¼ìŠ¤ ì‹œìŠ¤í…œ

### ëª©ì 
- ë¹„ê°œë°œì ê´€ë¦¬ìë“¤ì´ ì§ì ‘ DB ì¿¼ë¦¬ ì—†ì´ ì›¹ ì¸í„°í˜ì´ìŠ¤ë¡œ ë°ì´í„° ì¶”ì¶œ
- ì±„ë„ë³„ ì˜ˆì•½ ê±´ìˆ˜ ë° íŒë§¤ê¸ˆì•¡ í†µê³„ ì¡°íšŒ
- ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ í†µí•œ ì¶”ê°€ ë¶„ì„ ì§€ì›

### ì£¼ìš” ê¸°ëŠ¥
- ë‚ ì§œë³„/ì±„ë„ë³„ ì˜ˆì•½ ë°ì´í„° ì¡°íšŒ
- ë™ì  ì±„ë„ ëª©ë¡ ë¡œë“œ
- í†µí•© ì¿¼ë¦¬ë¥¼ í†µí•œ ë‹¤ì¤‘ í…Œì´ë¸” ë°ì´í„° ì¡°íšŒ
- ì¤‘ë³µ ì˜ˆì•½ ìë™ ì œê±°
- ì›í´ë¦­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ

---

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### 1. í…Œì´ë¸” êµ¬ì¡°

#### order_product í…Œì´ë¸”
- **ìš©ë„**: Expedia, Hotelbeds, ë‹¤ë³´, ëˆ„ì•„, í•˜ì´ì˜¤í‹° ë“± ì±„ë„ ë°ì´í„°
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `order_num`: ì˜ˆì•½ë²ˆí˜¸
  - `create_date`: ì˜ˆì•½ ìƒì„±ì¼
  - `order_type`: ì±„ë„ íƒ€ì… (expedia, hotelbeds ë“±)
  - `order_channel_idx`: ì±„ë„ ID (common_codeì™€ ì—°ê²°)
  - `order_product_status`: ì˜ˆì•½ ìƒíƒœ
  - `original_amount`: ê¸ˆì•¡

#### booking_master_offer í…Œì´ë¸”
- **ìš©ë„**: Trip, Meituan, Fliggy, Agoda ë“± ì¤‘êµ­ê³„ ì±„ë„ ë°ì´í„°
- **ì£¼ìš” ì»¬ëŸ¼**:
  - `bmo_bh_no`: ìš°ë¦¬íšŒì‚¬ ì˜ˆì•½ë²ˆí˜¸ (1ìˆœìœ„)
  - `bmo_hotelconfirm_no`: í˜¸í…” ì˜ˆì•½ë²ˆí˜¸ (2ìˆœìœ„)
  - `bmo_create_data`: ì˜ˆì•½ ìƒì„±ì¼
  - `bmo_sup_code`: ì±„ë„ ì½”ë“œ (ì±„ë„ ID ì—­í• )
  - `bmo_booking_status`: ì˜ˆì•½ ìƒíƒœ
  - `bmo_tot_amount_after_tax`: ì„¸í›„ ê¸ˆì•¡

#### common_code í…Œì´ë¸”
- **ìš©ë„**: ì±„ë„ëª… ë§ˆìŠ¤í„° ë°ì´í„°
- **ê´€ê³„**: order_channel_idxì™€ 1:1 ë§¤í•‘

### 2. ì±„ë„ë³„ ìƒíƒœê°’ ë§¤í•‘

#### order_product ì±„ë„ (ê³µí†µ)
```
ëª¨ë“  ì±„ë„: order_product_status = 'confirm'
```

#### booking_master_offer ì±„ë„ (ê°œë³„)
| ì±„ë„ | ì½”ë“œ | í™•ì • ìƒíƒœê°’ |
|------|------|------------|
| Trip | AMTSUPCT0001 | New |
| Meituan | AMTSUPME0003 | BOOKING |
| Fliggy | AMTSUPFL0004 | CONFIRMED |
| Dida | AMTSUPDI0005 | Confirmed |
| Agoda | AMTSUPAG0007 | BOOKING |
| Elong | AMTSUPEL0009 | Confirmed |
| PKFare | AMTSUPPK0008 | BOOKING |

### 3. ì¤‘ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™

- **ì¤‘ë³µ ë°ì´í„°**: í•œ ì±„ë„(ì˜ˆ: Agoda)ì´ order_productì™€ booking_master_offer í…Œì´ë¸” ëª¨ë‘ì— ì¡´ì¬ ê°€ëŠ¥
- **ì¤‘ë³µ ì œê±°**: ì˜ˆì•½ë²ˆí˜¸ ê¸°ì¤€ DISTINCT ì²˜ë¦¬
- **ë°ì´í„° ì‹œì **: ì¼ì¼ ë°°ì¹˜, ë‹¹ì¼ ë°ì´í„° ì œì™¸ (D-1ê¹Œì§€ë§Œ ì¡°íšŒ)
- **ì˜ˆì•½ë²ˆí˜¸ ìš°ì„ ìˆœìœ„**: 
  1. order_product: `order_num`
  2. booking_master_offer: `bmo_bh_no` â†’ `bmo_hotelconfirm_no`

---

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

- **Frontend**: Streamlit (Python ì›¹ í”„ë ˆì„ì›Œí¬)
- **Backend**: Python 3.8+
- **Database**: MySQL
- **ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬**:
  - `pandas`: ë°ì´í„° ì²˜ë¦¬
  - `sqlalchemy`: DB ì—°ê²°
  - `streamlit`: ì›¹ UI
  - `openpyxl`: ì—‘ì…€ ìƒì„±
  - `python-dotenv`: í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬

---

## ğŸ“Š í†µí•© ì¿¼ë¦¬

```sql
WITH all_bookings AS (
    -- order_product í…Œì´ë¸”
    SELECT 
        DATE(op.create_date) as booking_date,
        op.order_num as booking_id,
        op.order_type as channel_type,
        op.order_channel_idx as channel_code,
        COALESCE(cc.code_name, op.order_type) as channel_name,
        op.original_amount as amount
    FROM allmytourdb.order_product op
    LEFT JOIN allmytourdb.common_code cc 
        ON cc.code_id = op.order_channel_idx 
        AND cc.parent_idx = 1
    WHERE op.create_date >= :start_date
        AND op.create_date < :end_date
        AND op.create_date < CURDATE()
        AND op.order_product_status = 'confirm'
    
    UNION ALL
    
    -- booking_master_offer í…Œì´ë¸”
    SELECT 
        DATE(bmo.bmo_create_data) as booking_date,
        COALESCE(bmo.bmo_bh_no, bmo.bmo_hotelconfirm_no) as booking_id,
        bmo.bmo_sup_code as channel_type,
        bmo.bmo_sup_code as channel_code,
        CASE bmo.bmo_sup_code
            WHEN 'AMTSUPCT0001' THEN 'Trip'
            -- ... ê° ì±„ë„ ë§¤í•‘
        END as channel_name,
        bmo.bmo_tot_amount_after_tax as amount
    FROM allmytourdb.booking_master_offer bmo
    WHERE bmo.bmo_create_data >= :start_date
        AND bmo.bmo_create_data < :end_date
        AND bmo.bmo_create_data < CURDATE()
        AND bmo.bmo_booking_top_status = 1
        AND (
            -- ê° ì±„ë„ë³„ ìƒíƒœ ì¡°ê±´
        )
)
SELECT 
    booking_date,
    channel_name,
    COUNT(DISTINCT booking_id) as booking_count,
    SUM(amount) as total_amount
FROM all_bookings
GROUP BY booking_date, channel_name
```

---

## ğŸ¯ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

### í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°
```
1. ë°±ì˜¤í”¼ìŠ¤ ì ‘ì† (URL)
   â†“
2. ê²€ìƒ‰ ì¡°ê±´ ì„¤ì •
   - ë‚ ì§œ ë²”ìœ„ (ì‹œì‘ì¼ ~ ì¢…ë£Œì¼)
   - ì±„ë„ ì„ íƒ (ë©€í‹°ì…€ë ‰íŠ¸)
   - ì˜ˆì•½ ìƒíƒœ (í˜„ì¬ëŠ” 'í™•ì •'ë§Œ)
   â†“
3. [ì¡°íšŒ] ë²„íŠ¼ í´ë¦­
   â†“
4. DB ì¿¼ë¦¬ ì‹¤í–‰ ë° ë°ì´í„° ì²˜ë¦¬
   â†“
5. ê²°ê³¼ í‘œì‹œ
   - ìš”ì•½ ì§€í‘œ (ì´ ì˜ˆì•½ìˆ˜, ì´ ê¸ˆì•¡ ë“±)
   - ë°ì´í„° í…Œì´ë¸”
   - ì°¨íŠ¸ ì‹œê°í™”
   â†“
6. [ì—‘ì…€ ë‹¤ìš´ë¡œë“œ] ë²„íŠ¼ í´ë¦­
   â†“
7. ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
```

### ì‚¬ìš© ì˜ˆì‹œ
- "ì–´ì œ Expediaì™€ Trip ì±„ë„ì˜ ì˜ˆì•½ í˜„í™© ì¡°íšŒ"
- "ì´ë²ˆ ë‹¬ ì „ì²´ ì±„ë„ ì¼ë³„ ì˜ˆì•½ í†µê³„"
- "íŠ¹ì • ê¸°ê°„ Agoda ì±„ë„ ë§¤ì¶œ í™•ì¸"

---

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
channel-stats-system/
â”œâ”€â”€ app.py                    # Streamlit ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ channels.py          # ì±„ë„ ì„¤ì • ë° ë§¤í•‘
â”‚   â””â”€â”€ database.py          # DB ì—°ê²° ì„¤ì •
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ query_builder.py     # ë™ì  ì¿¼ë¦¬ ìƒì„±
â”‚   â””â”€â”€ excel_handler.py     # ì—‘ì…€ ì²˜ë¦¬
â”œâ”€â”€ requirements.txt         # íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
â”œâ”€â”€ .env                    # í™˜ê²½ë³€ìˆ˜ (DB ì ‘ì† ì •ë³´)
â””â”€â”€ README.md               # í”„ë¡œì íŠ¸ ë¬¸ì„œ
```

---

## ğŸ”§ ì±„ë„ ì„¤ì • (channels.py)

```python
CHANNEL_CONFIG = {
    'order_product': {
        'expedia': {'status': 'confirm', 'name': 'Expedia'},
        'expediab2b': {'status': 'confirm', 'name': 'Expedia B2B'},
        'hotelbeds': {'status': 'confirm', 'name': 'Hotelbeds'},
        'dabo': {'status': 'confirm', 'name': 'ë‹¤ë³´'},
        'nuuaapi': {'status': 'confirm', 'name': 'ëˆ„ì•„'},
        'hiot': {'status': 'confirm', 'name': 'í•˜ì´ì˜¤í‹°'}
    },
    'booking_master_offer': {
        'AMTSUPCT0001': {'status': 'New', 'name': 'Trip'},
        'AMTSUPME0003': {'status': 'BOOKING', 'name': 'Meituan'},
        'AMTSUPFL0004': {'status': 'CONFIRMED', 'name': 'Fliggy'},
        'AMTSUPDI0005': {'status': 'Confirmed', 'name': 'Dida'},
        'AMTSUPAG0007': {'status': 'BOOKING', 'name': 'Agoda'},
        'AMTSUPEL0009': {'status': 'Confirmed', 'name': 'Elong'},
        'AMTSUPPK0008': {'status': 'BOOKING', 'name': 'PKFare'}
    }
}
```

---

## ğŸš€ ë°°í¬ ë° ìš´ì˜

### ë°°í¬ ì˜µì…˜
1. **Streamlit Cloud** (ë¬´ë£Œ, ë¹ ë¥¸ ì‹œì‘)
2. **ì‚¬ë‚´ ì„œë²„** (ë³´ì•ˆ, ì•ˆì •ì„±)
3. **í´ë¼ìš°ë“œ ì„œë²„** (AWS EC2, Oracle Cloud)

### ìš´ì˜ ê³ ë ¤ì‚¬í•­
- **ë³´ì•ˆ**: DB ì ‘ì† ì •ë³´ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
- **ì„±ëŠ¥**: ëŒ€ëŸ‰ ë°ì´í„°ëŠ” í˜ì´ì§• ì²˜ë¦¬
- **ìºì‹±**: ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„°ëŠ” ìºì‹œ í™œìš©
- **ë¡œê¹…**: ì‚¬ìš©ìë³„ ì¡°íšŒ ì´ë ¥ ê¸°ë¡

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ë°ì´í„° ì‹œì **: ì¼ì¼ ë°°ì¹˜ë¡œ ì¸í•´ ë‹¹ì¼ ë°ì´í„°ëŠ” ì¡°íšŒ ë¶ˆê°€
2. **ì¤‘ë³µ ì²˜ë¦¬**: Agoda ë“± ì¼ë¶€ ì±„ë„ì€ ì—¬ëŸ¬ í…Œì´ë¸”ì— ì¡´ì¬ (ìë™ ì¤‘ë³µ ì œê±°)
3. **ìƒíƒœê°’**: ê° ì±„ë„ë³„ë¡œ 'í™•ì •' ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°’ì´ ë‹¤ë¦„
4. **NULL ì²˜ë¦¬**: ì˜ˆì•½ë²ˆí˜¸ê°€ ì—†ëŠ” ê²½ìš° ì œì™¸

---

## ğŸ“ í–¥í›„ ê°œë°œ ê³„íš

- [ ] ì·¨ì†Œ/í™˜ë¶ˆ ìƒíƒœ ì¶”ê°€
- [ ] ì²´í¬ì¸/ì²´í¬ì•„ì›ƒ ë‚ ì§œ ê¸°ì¤€ ì¡°íšŒ
- [ ] ì‹¤ì‹œê°„ ë°ì´í„° ì¡°íšŒ (ë‹¹ì¼ í¬í•¨)
- [ ] ì‚¬ìš©ìë³„ ê¶Œí•œ ê´€ë¦¬
- [ ] ìë™ ë¦¬í¬íŠ¸ ì´ë©”ì¼ ë°œì†¡
- [ ] API ì—”ë“œí¬ì¸íŠ¸ ì œê³µ

---

## ğŸ¤ ë‹´ë‹¹ì

- **í”„ë¡œì íŠ¸ ê¸°íš**: ì„±ê·  (ì„œë¹„ìŠ¤ ê¸°íšì)
- **ê°œë°œ ì§€ì›**: ê°œë°œíŒ€ (DB ì ‘ì† ê¶Œí•œ, ì¿¼ë¦¬ ê²€í† )
- **ìš´ì˜**: í”Œë«í¼ ê´€ë¦¬íŒ€

---

## ğŸ“ ë¬¸ì˜ì‚¬í•­

í”„ë¡œì íŠ¸ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì•„ë˜ë¡œ ì—°ë½ ì£¼ì„¸ìš”:
- ê¸°íš ê´€ë ¨: [ë‹´ë‹¹ì ì´ë©”ì¼]
- ê¸°ìˆ  ì§€ì›: [ê°œë°œíŒ€ ì´ë©”ì¼]

---

*Last Updated: 2025.01.16*