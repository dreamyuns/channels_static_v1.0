# 숙소별 예약 통계 시스템 v1.3

숙소별 예약 통계를 실시간으로 조회하고 엑셀로 추출할 수 있는 Streamlit 기반 웹 애플리케이션입니다.

## 📋 개요

이 시스템은 allmytour.com의 숙소별 예약 데이터를 조회하고 통계를 제공합니다. 사용자는 날짜 범위와 숙소를 선택하여 예약 건수, 입금가, 실구매가, 수익 등의 통계를 확인할 수 있습니다.

## 🎯 주요 기능

### 1. 사용자 인증
- `tblmanager` 테이블 기반 로그인 시스템
- 쿠키 기반 인증 상태 유지 (새로고침 시에도 로그인 유지)
- `user_status = '1'`인 사용자만 접근 가능
- bcrypt, MD5, SHA256, 평문 비밀번호 지원

### 2. 판매유형 선택
- 판매유형 필터 추가 (전체/b2c/b2b)
- '전체' 선택 시 모든 판매유형 조회
- 'b2c' 또는 'b2b' 선택 시 해당 판매유형만 조회
- `product_rateplan` 테이블의 `sale_type` 값 사용

### 3. 숙소 검색
- 숙소명 또는 숙소코드로 검색
- 엔터키로 검색 실행 (검색 버튼 없음)
- 최대 15개 검색 결과 표시
- 최대 10개 숙소 선택 가능
- 선택된 숙소는 검색 결과에서 제외 (중복 선택 방지)
- 선택된 숙소는 체크박스로 관리 (체크 해제 시 삭제)

### 4. 날짜 범위 조회
- **날짜유형 선택**: 구매일(예약일) 또는 이용일(체크인) 기준
- **구매일 기준**: 오늘 기준 90일 전 ~ 어제까지 선택 가능 (당일 데이터 조회 불가)
- **이용일 기준**: 오늘 기준 90일 전 ~ 90일 후까지 선택 가능
- 최대 90일(3개월) 조회 기간 제한

### 5. 통계 조회
- **요약 통계** (2행 4컬럼):
  - 1행: 총 예약건수, 총 입금가, 총 실구매가, 총 수익
  - 2행: 총 객실수, 확정 객실 수, 취소 객실 수, 취소율
- **상세 데이터**:
  - 날짜, 숙소명, 채널명, 판매유형, 예약건수, 총객실수, 확정객실수, 취소객실수, 취소율
  - 총 입금가, 총 실구매가, 총 수익, 수익률
  - 상위 10개만 화면에 표시 (전체 데이터는 엑셀 다운로드)

### 6. 엑셀 다운로드
- 전체 데이터를 엑셀 파일로 다운로드
- 날짜유형별 시트 자동 생성
- 요약 통계 포함

### 7. 로깅 시스템
- 타입별 로그 파일 분리: `auth.log`, `error.log`, `access.log`, `app.log`
- 30일 보관 정책
- 모든 사용자 액션 로깅

## 🛠️ 기술 스택

- **Frontend**: Streamlit 1.28.0+
- **Backend**: Python 3.12+
- **Database**: MySQL (SQLAlchemy)
- **Data Processing**: Pandas
- **Excel Export**: openpyxl
- **Authentication**: bcrypt, 쿠키 기반 세션 관리
- **Logging**: Python logging (파일 로테이션)

## 📦 설치 방법

### 1. 저장소 클론

```bash
git clone https://github.com/dreamyuns/channels_static_v1.0.git
cd channels_static_v1.0
```

### 2. 가상환경 생성 및 활성화

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Mac/Linux
python -m venv venv
source venv/bin/activate
```

### 3. 패키지 설치

```bash
pip install -r requirements.txt
```

### 4. 환경 변수 설정

`.env.example` 파일을 참고하여 `.env` 파일을 생성하고 데이터베이스 연결 정보를 입력하세요.

```bash
# .env 파일 생성
DB_HOST=your_database_host
DB_PORT=3306
DB_USER=your_database_user
DB_PASSWORD=your_database_password
DB_NAME=your_database_name
```

**⚠️ 중요**: `.env` 파일은 절대 Git에 커밋하지 마세요!

### 5. master_data.xlsx 파일 준비

프로젝트 루트에 `master_data.xlsx` 파일을 배치하세요. 다음 시트가 필요합니다:
- `date_types`: 날짜유형 마스터 (date_types_en, date_types_kr)

### 6. 애플리케이션 실행

```bash
streamlit run app_v1.3_hotel.py --server.port=8502
```

브라우저에서 `http://localhost:8502`로 접속하세요.

**서버 배포 시:**
- 로컬: 포트 8502
- 서버: 포트 8008

## 📖 사용 방법

### 1. 로그인
- `tblmanager` 테이블의 `admin_id`와 `passwd`로 로그인
- `user_status = '1'`인 계정만 접근 가능
- 로그인 상태는 브라우저 쿠키에 저장되어 새로고침 시에도 유지됨

### 2. 검색 조건 설정
1. **날짜유형 선택**: 구매일 또는 이용일 선택
2. **날짜 범위 선택**: 시작일과 종료일 선택
   - 이용일 기준: 오늘 기준 90일 전 ~ 90일 후까지 선택 가능
   - 구매일 기준: 오늘 기준 90일 전 ~ 어제까지 선택 가능
3. **판매유형 선택**: 전체, b2c, b2b 중 선택
   - '전체'를 선택하면 모든 판매유형이 조회됩니다
4. **숙소 검색**: 숙소명 또는 숙소코드 입력 후 엔터키로 검색
   - 검색 결과에서 숙소 선택 (최대 10개)
   - 선택된 숙소는 체크박스로 표시 (체크 해제 시 삭제)

### 3. 조회
- **"조회"** 버튼 클릭하여 데이터 조회
- 결과 화면에 요약 통계와 상세 데이터 표시

### 4. 엑셀 다운로드
- **"엑셀 파일 다운로드"** 버튼으로 전체 데이터 다운로드

### 5. 초기화
- **"초기화"** 버튼으로 모든 필터를 기본값으로 되돌림

## 🗄️ 데이터베이스 구조

### 주요 테이블

- `product`: 숙소 마스터 데이터
  - `idx`: 숙소 ID (PK)
  - `product_code`: 숙소코드
  - `name_kr`: 숙소 한글명
  - `reg_date`: 등록일

- `order_product`: 예약 상품 데이터
  - `idx`: 예약 상품 ID (PK)
  - `product_idx`: 숙소 ID (FK → product.idx)
  - `create_date`: 구매일(예약일)
  - `checkin_date`: 이용일(체크인)
  - `order_product_status`: 예약상태
  - `order_channel_idx`: 채널 ID
  - `order_pay_idx`: 결제 정보 ID
  - `rateplan_idx`: 요금제 ID (FK → product_rateplan.idx)
  - `terms`: 숙박기간 (박)
  - `room_cnt`: 객실수

- `order_item`: 예약 상세 항목
  - `idx`: 항목 ID (PK)
  - `order_product_idx`: 예약 상품 ID (FK → order_product.idx)
  - `stay_date`: 숙박일
  - `due_price`: 해당 날짜의 입금가

- `order_pay`: 결제 정보
  - `idx`: 결제 ID (PK)
  - `total_amount`: 실구매가

- `product_rateplan`: 요금제 마스터 데이터
  - `idx`: 요금제 ID (PK)
  - `sale_type`: 판매유형 ('b2c', 'b2b')

- `common_code`: 채널명 마스터 데이터
  - `code_id`: 채널 ID
  - `code_name`: 채널명

- `tblmanager`: 관리자 계정 정보
  - `admin_id`: 관리자 ID (로그인 ID)
  - `passwd`: 비밀번호 (bcrypt 해시)
  - `user_status`: 계정 상태 ('1' = 활성, '0' = 비활성)

### 테이블 관계

```
product (1) ──< (N) order_product
    │
    └── (1) ──< (N) order_item
    │
    └── (1) ──< (1) order_pay
    │
    └── (N) ──< (1) common_code
    │
    └── (N) ──< (1) product_rateplan
```

## 🔍 숙소 검색 로직

### 검색 범위
- **구매일 기준**: 최근 180일 이내 예약이 있는 숙소
- **이용일 기준**: 오늘 기준 앞뒤 180일 이내 예약이 있는 숙소
- **신규 숙소**: 최근 90일 이내 등록된 숙소 (`product.reg_date`)

### 검색 최적화
- 최소 2자 이상 입력 필요
- BTREE 인덱스 활용 (`name_kr`, `product_code`)
- 검색 결과 캐싱 (1시간)

### 검색 결과 우선순위
1. 최근 예약이 있거나 신규 등록된 숙소 우선 표시
2. 최대 15개 검색 결과 표시
3. 선택된 숙소는 검색 결과에서 제외 (중복 선택 방지)

## 🔒 보안 주의사항

- ⚠️ **절대 커밋하지 마세요**:
  - `.env` 파일 (데이터베이스 접속 정보)
  - `master_data.xlsx` (민감한 데이터)
  - `logs/` 폴더 (로그 파일에 민감한 정보 포함될 수 있음)

### 보안 기능

- **사용자 인증**: `tblmanager` 테이블 기반 로그인 시스템
- **계정 상태 확인**: `user_status = '1'`인 사용자만 접근 가능
- **비밀번호 해싱**: bcrypt, MD5, SHA256, 평문 순서로 검증 시도
- **세션 관리**: 쿠키 기반 인증 상태 유지 (1일 유효)
- **로깅**: 모든 인증 시도와 접근 기록 저장

## 📝 로깅 시스템

### 로그 파일 구조
- `logs/auth.log`: 인증 관련 로그 (로그인, 로그아웃, 인증 실패)
- `logs/error.log`: 에러 로그 (예외, SQL 오류)
- `logs/access.log`: 접근 로그 (페이지 접근, 쿼리 실행)
- `logs/app.log`: 일반 애플리케이션 로그

### 로깅 정책
- 일별 로그 파일 로테이션
- 30일 보관 후 자동 삭제
- 5초 이상 실행된 쿼리 자동 로깅

## 🚀 버전 히스토리

### v1.3 (현재 버전)
- ✨ **판매유형 필터 기능 추가**
  - 판매유형 선택 필터 추가 (전체/b2c/b2b)
  - `product_rateplan` 테이블과 조인하여 `sale_type` 값 사용
  - 상세 데이터에 '판매유형' 컬럼 추가 (채널명 다음 위치)
  - 엑셀 다운로드에도 '판매유형' 컬럼 포함
  - '숙소검색' 위에 '판매유형선택' 셀렉트박스 배치
- ✨ **검색 기능 개선**
  - 검색 버튼 삭제, 엔터키로만 검색
  - 선택된 숙소는 셀렉트박스 옵션에서 제외 (중복 선택 방지)
  - 선택 후 셀렉트박스 비우기
- ✨ **UI 개선**
  - 데이터 조회 완료 메시지 접기/펼치기 제거 (`st.spinner` 사용)
  - 사용안내 영역을 엑셀 다운로드 하단으로 이동

### v1.1
- 🔐 **사용자 인증 기능**
  - `tblmanager` 테이블 기반 로그인 시스템
  - 쿠키 기반 인증 상태 유지
- 📝 **로깅 시스템**
  - 타입별 로그 파일 분리
- 🔍 **숙소 검색 기능**
  - 숙소명 또는 숙소코드로 검색
  - 최대 10개 숙소 선택

### v1.0
- 🎉 **초기 릴리스**
- 📊 **숙소별 통계 조회**
  - 날짜별/숙소별/채널별 집계
  - 요약 통계 및 상세 데이터 표시
- 📥 **엑셀 다운로드**

## 📚 추가 문서

자세한 가이드는 `docs/` 폴더를 참고하세요:
- `docs/숙소별 예약 통계 시스템.md`: 숙소별 통계 시스템 상세 문서

## 📞 문의

프로젝트 관련 문의는 GitHub Issues를 통해 등록해주세요.

